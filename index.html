<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة كنوز | شبكة الأصول الاستراتيجية العالمية</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap');
        
        :root { 
            --primary: #f59e0b; 
            --primary-dark: #d97706;
            --bg-dark: #020617; 
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
        }
        
        body { 
            font-family: 'Cairo', sans-serif; 
            scroll-behavior: smooth; 
            overflow-x: hidden; 
            background-color: #f8fafc;
        }

        .page-section { min-height: 100vh; padding-top: 1rem; }
        .hidden { display: none !important; }
        .active-section { display: block; animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* نظام البطاقات المتجاوب المحسن للجوال */
        @media (max-width: 1024px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { 
                display: block; 
                margin-bottom: 1.5rem; 
                background: white; 
                border-radius: 1.5rem; 
                padding: 1rem; 
                border: 1px solid #e2e8f0; 
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                width: 100%;
            }
            .admin-theme .responsive-table tr {
                background: rgba(255,255,255,0.03);
                border-color: rgba(255,255,255,0.08);
            }
            .responsive-table td { 
                display: flex; 
                flex-wrap: wrap; /* يسمح للنص بالنزول للسطر التالي إذا كان طويلاً */
                justify-content: space-between; 
                align-items: center; 
                padding: 0.75rem 0; 
                border-bottom: 1px solid rgba(0,0,0,0.05); 
                gap: 0.5rem;
            }
            .admin-theme .responsive-table td { border-bottom: 1px solid rgba(255,255,255,0.05); }
            
            /* خلية الإجراء في الجوال */
            .responsive-table td:last-child { 
                border: none; 
                padding-top: 1rem; 
                justify-content: center; 
                width: 100%; 
                background: rgba(245, 158, 11, 0.05);
                border-radius: 1rem;
                margin-top: 0.5rem;
            }
            .responsive-table td::before { 
                content: attr(data-label); 
                font-weight: 800; 
                color: #94a3b8; 
                font-size: 0.7rem; 
                flex-shrink: 0;
            }
            .responsive-table td .val-content {
                max-width: 65%;
                word-break: break-word; /* يمنع خروج النص عن حدود الخلية */
                text-align: left;
            }
        }

        /* تحسين التمرير */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        
        .admin-theme { background-color: var(--bg-dark); color: white; }
        
        #notification { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%) translateY(150px); 
            transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); 
            z-index: 10000; 
        }
        #notification.show { transform: translateX(-50%) translateY(0); }
        
        .progress-ring { transition: stroke-dashoffset 0.8s ease; transform: rotate(-90deg); transform-origin: 50% 50%; }
        #project-map { height: 450px; width: 100%; border-radius: 1.5rem; z-index: 10; border: 2px solid rgba(255,255,255,0.05); }

        /* فقاعات الدردشة */
        .chat-sent { background: var(--primary); color: #000; border-radius: 1rem 1rem 0 1rem; padding: 0.75rem 1rem; }
        .chat-received { background: #f1f5f9; color: #000; border-radius: 1rem 1rem 1rem 0; padding: 0.75rem 1rem; }
    </style>
</head>
<body class="text-slate-900 bg-slate-50">

    <!-- شاشة التحميل -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-950 z-[11000] hidden flex flex-col items-center justify-center backdrop-blur-3xl">
        <div class="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-white font-black text-sm italic tracking-widest uppercase">جاري تشغيل محرك كنوز الاستراتيجي...</p>
    </div>

    <!-- الإشعارات -->
    <div id="notification" class="bg-slate-950/95 text-white px-8 py-4 rounded-2xl shadow-2xl border border-white/10 flex items-center gap-4 min-w-[300px]">
        <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-slate-950">
            <i data-lucide="bell" class="w-5 h-5"></i>
        </div>
        <p id="notification-text" class="text-xs font-bold"></p>
    </div>

    <!-- القائمة العلوية -->
    <nav class="fixed top-0 w-full z-[1000] bg-white/90 backdrop-blur-md border-b border-slate-100 px-4 lg:px-16 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3 cursor-pointer" onclick="showPage('landing')">
            <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-slate-950 font-black text-xl">ك</div>
            <div class="hidden xs:block leading-none text-right">
                <span class="text-xl font-black text-slate-950 block tracking-tighter">كنوز <span class="text-amber-600 italic">للمؤسسات</span></span>
                <span class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">Global Asset Intelligence</span>
            </div>
        </div>
        
        <div class="hidden lg:flex items-center gap-8 text-slate-600 font-bold text-[10px] uppercase">
            <button onclick="showPage('landing')" class="hover:text-amber-500 transition-colors">الرئيسية</button>
            <button onclick="showPage('ent-dash')" class="hover:text-amber-500 transition-colors">لوحة الرائد</button>
            <button id="nav-inv-btn" onclick="showPage('inv-dash')" class="hidden text-green-600">لوحة المستثمر</button>
            <button id="nav-adm-btn" onclick="showPage('dashboard')" class="hidden text-blue-600 font-black">Strategy BI</button>
            <button id="nav-msg-btn" onclick="showPage('messages')" class="hidden text-slate-400">الرسائل</button>
        </div>

        <div class="flex items-center gap-3">
            <div id="role-switcher" class="bg-slate-100 p-1 rounded-full flex gap-1 border">
                <button onclick="setRole('user')" id="role-user-btn" class="px-3 py-1.5 rounded-full text-[8px] font-black bg-white shadow-sm text-slate-900 border">رائد أعمال</button>
                <button onclick="setRole('investor')" id="role-inv-btn" class="px-3 py-1.5 rounded-full text-[8px] font-black text-slate-400">مستثمر</button>
                <button onclick="setRole('admin')" id="role-adm-btn" class="px-3 py-1.5 rounded-full text-[8px] font-black text-slate-400">إدارة</button>
            </div>
            <button class="lg:hidden p-2 bg-slate-100 rounded-xl" onclick="toggleMobileMenu()"><i data-lucide="menu" class="w-5 h-5"></i></button>
        </div>
    </nav>

    <!-- قائمة الجوال -->
    <div id="mobile-menu" class="fixed inset-0 bg-slate-950/98 z-[1500] hidden flex-col items-center justify-center text-white gap-8 font-black text-xl italic uppercase">
        <button onclick="toggleMobileMenu()" class="absolute top-6 right-6 p-4"><i data-lucide="x" class="w-10 h-10"></i></button>
        <button onclick="showPage('landing'); toggleMobileMenu()">الرئيسية</button>
        <button onclick="showPage('ent-dash'); toggleMobileMenu()">لوحة الرائد</button>
        <button id="mob-inv-btn" class="hidden text-green-500" onclick="showPage('inv-dash'); toggleMobileMenu()">لوحة المستثمر</button>
        <button id="mob-adm-btn" class="hidden text-blue-500" onclick="showPage('dashboard'); toggleMobileMenu()">Strategy BI</button>
    </div>

    <main class="mt-[80px]">
        
        <!-- الرئيسية -->
        <section id="landing-page" class="page-section active-section">
            <div class="relative py-16 lg:py-32 px-6 bg-slate-950 text-white min-h-[85vh] flex items-center overflow-hidden">
                <div class="container mx-auto grid lg:grid-cols-2 gap-12 items-center relative z-10">
                    <div class="text-right space-y-8">
                        <span class="inline-block px-4 py-1 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-500 text-[10px] font-black uppercase tracking-widest">نظام الاستحواذ السيادي</span>
                        <h1 class="text-5xl lg:text-[6rem] font-black leading-[0.9] tracking-tighter">أصولك <br><span class="text-amber-500 italic">استراتيجية</span></h1>
                        <p class="text-slate-400 text-lg lg:text-xl max-w-xl font-light">ربط الأصول العملاقة بكبار المستثمرين عبر تحليل البيانات الضخمة (BI) ومصفوفة التشخيص العالمية.</p>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="showPage('form')" class="bg-amber-500 text-slate-950 px-10 py-5 rounded-2xl font-black shadow-xl hover:scale-105 transition-all text-xs">سجل مشروعك للتمويل</button>
                            <button onclick="setRole('admin')" class="bg-white/5 border border-white/10 px-8 py-5 rounded-2xl font-bold backdrop-blur-md text-xs">استعرض محرك BI</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="py-20 bg-white px-6">
                <div class="container mx-auto">
                    <h2 class="text-3xl font-black text-slate-900 mb-12 text-center">القطاعات الاستراتيجية المشمولة</h2>
                    <div id="sectors-ref-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>
            </div>
        </section>

        <!-- لوحة الرائد -->
        <section id="ent-dash-page" class="page-section hidden py-12 px-6 text-right bg-slate-50 min-h-screen">
            <div class="container mx-auto max-w-6xl">
                <header class="mb-12 flex flex-col md:flex-row justify-between items-end gap-6">
                    <div>
                        <h2 class="text-4xl font-black tracking-tighter uppercase italic">بوابة <span class="text-amber-500">النمو</span></h2>
                        <p class="text-slate-400 text-[10px] font-black mt-2">متابعة حالة مشروعك ومواءمة المستثمرين لحظياً</p>
                    </div>
                    <div class="bg-white px-6 py-3 rounded-2xl border shadow-sm text-[10px] font-black text-green-500 uppercase flex items-center gap-3">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-ping"></div> جاري المراجعة الاستراتيجية
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                    <div class="bg-white p-10 rounded-[3rem] shadow-xl border flex flex-col items-center justify-center text-center">
                        <div class="relative w-48 h-48 mb-6">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-slate-50" stroke-width="6" stroke="currentColor" fill="transparent" r="42" cx="50" cy="50" />
                                <circle class="text-amber-500 progress-ring" id="ready-progress-ent" stroke-width="8" stroke-dasharray="263.8" stroke-dashoffset="65" stroke-linecap="round" stroke="currentColor" fill="transparent" r="42" cx="50" cy="50" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-4xl font-black italic">75%</span>
                                <span class="text-[8px] font-black text-slate-400 uppercase mt-1">معدل الجاهزية</span>
                            </div>
                        </div>
                        <h4 class="font-black text-slate-800 text-lg">بانتظار توقيع الـ MoU</h4>
                    </div>

                    <div class="lg:col-span-2 bg-white p-10 rounded-[3rem] shadow-xl border overflow-hidden">
                        <div class="flex justify-between items-center mb-8">
                            <h4 class="font-black text-lg">التدفقات والنمو المالي</h4>
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest italic">Live BI Sync</span>
                        </div>
                        <div class="h-48 flex items-end gap-4 px-4" id="sales-flow-bars-ent">
                            <div class="bg-slate-100 w-full rounded-t-2xl h-[40%]"></div>
                            <div class="bg-slate-100 w-full rounded-t-2xl h-[60%]"></div>
                            <div class="bg-slate-100 w-full rounded-t-2xl h-[45%]"></div>
                            <div class="bg-amber-500 w-full rounded-t-2xl h-[95%] shadow-lg animate-pulse"></div>
                            <div class="bg-slate-100 w-full rounded-t-2xl h-[70%]"></div>
                            <div class="bg-slate-100 w-full rounded-t-2xl h-[85%]"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-slate-950 text-white p-8 rounded-[2.5rem] flex items-center gap-6 shadow-xl">
                        <div class="w-12 h-12 bg-amber-500 rounded-2xl flex items-center justify-center text-slate-950"><i data-lucide="users"></i></div>
                        <div><p class="text-[8px] text-slate-500 font-black mb-1 uppercase">مستثمرون مهتمون</p><p class="text-2xl font-black italic">18</p></div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border flex items-center gap-6 shadow-sm">
                        <div class="w-12 h-12 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center"><i data-lucide="target"></i></div>
                        <div><p class="text-[8px] text-slate-400 font-black mb-1 uppercase">المواءمة الاستراتيجية</p><p class="text-2xl font-black italic">94%</p></div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border flex items-center gap-6 shadow-sm">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center"><i data-lucide="award"></i></div>
                        <div><p class="text-[8px] text-slate-400 font-black mb-1 uppercase">القرار القادم</p><p class="text-2xl font-black italic">تحليل MoU</p></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- لوحة المستثمر -->
        <section id="inv-dash-page" class="page-section hidden min-h-screen admin-theme py-16 px-6 text-right">
            <div class="container mx-auto">
                <header class="mb-16 flex flex-col lg:flex-row justify-between items-end gap-8">
                    <div class="space-y-2">
                        <h2 class="text-5xl font-black text-green-500 italic">عالم <span class="text-white">المستثمر</span></h2>
                        <p class="text-slate-500 text-[10px] font-black uppercase tracking-[0.4em]">إدارة المحفظة وتدفقات السيولة السيادية</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl border border-white/10 flex gap-12 text-[9px] font-black">
                        <div><span class="text-slate-500 block mb-1">الأصول المدارة</span><span class="text-green-400 text-2xl font-black">$450.8M</span></div>
                        <div class="border-r border-white/10 pr-12"><span class="text-slate-500 block mb-1">تحت المراقبة</span><span class="text-amber-400 text-2xl font-black">14 كيان</span></div>
                    </div>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-16 text-right">
                    <div class="glass-card p-10 rounded-[3rem] border-r-4 border-r-green-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">متوسط العائد السنوي</p>
                        <h3 class="text-5xl font-black text-green-400 italic">32.8%</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-r-4 border-r-amber-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">صفقات الاستحواذ</p>
                        <h3 class="text-5xl font-black text-amber-500 italic">14 صفقة</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-r-4 border-r-blue-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">التوزيع الجغرافي</p>
                        <h3 class="text-5xl font-black text-blue-400 italic">8 مدن</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-r-4 border-r-purple-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">مستوى المواءمة</p>
                        <h3 class="text-5xl font-black text-purple-400 italic">عالي</h3>
                    </div>
                </div>

                <div class="bg-slate-900/50 rounded-[4rem] border border-white/5 p-10 shadow-2xl relative overflow-hidden">
                    <h4 class="font-black text-2xl mb-12 flex items-center gap-6 italic">
                        <i data-lucide="sparkles" class="text-green-400 w-8 h-8"></i> الفرص المفلترة بالذكاء الاصطناعي (AI Matching)
                    </h4>
                    <div id="investor-match-list" class="space-y-6"></div>
                </div>
            </div>
        </section>

        <!-- لوحة الإدارة Strategy BI -->
        <section id="dashboard-page" class="page-section hidden min-h-screen admin-theme py-16 px-6 text-right">
            <div class="container mx-auto">
                <header class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-16 gap-8">
                    <div class="space-y-2">
                        <h2 class="text-6xl font-black text-blue-500 italic uppercase leading-none">Strategy <span class="text-white">BI</span></h2>
                        <p class="text-slate-500 text-[10px] font-black mt-3 uppercase tracking-[0.4em]">محطة الاستخبارات السيادية والتحكم في الأصول العملاقة</p>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="window.print()" class="bg-white/5 border border-white/10 px-8 py-4 rounded-2xl text-[8px] font-black uppercase italic"><i data-lucide="printer" class="inline w-3 h-3 ml-2"></i> تصدير التقرير</button>
                        <button onclick="showPage('map')" class="bg-blue-600 px-12 py-4 rounded-2xl font-black text-[10px] shadow-lg uppercase tracking-widest">خارطة التدفقات</button>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
                    <div class="glass-card p-10 rounded-[3rem] border-t-4 border-t-blue-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">الفرص النشطة</p>
                        <h3 id="stat-total" class="text-5xl font-black italic text-white">0</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-t-4 border-t-green-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">السيولة المستهدفة</p>
                        <h3 id="stat-total-funding" class="text-4xl font-black text-white">$0M</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-t-4 border-t-amber-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">متوسط الربحية</p>
                        <h3 id="stat-avg-profit" class="text-5xl font-black italic text-white">0%</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-t-4 border-t-purple-500">
                        <p class="text-[8px] text-slate-500 font-black mb-2 uppercase">كفاءة الفريق</p>
                        <h3 id="stat-avg-team" class="text-5xl font-black italic text-white">0/5</h3>
                    </div>
                </div>

                <!-- الفلترة -->
                <div class="bg-white/5 p-8 rounded-[3rem] border border-white/10 mb-12 shadow-inner">
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 items-end text-right text-[10px] font-black">
                        <div class="lg:col-span-2 space-y-2">
                            <label class="text-slate-500 uppercase tracking-widest mr-2">البحث الاستراتيجي العميق</label>
                            <input type="text" id="filter-search" oninput="applyFilters()" placeholder="البحث..." class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none focus:ring-1 focus:ring-amber-500 text-white font-bold">
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-500 uppercase tracking-widest mr-2">القطاع</label>
                            <select id="filter-sector" onchange="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none text-white font-bold"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-500 uppercase tracking-widest mr-2">المخاطرة</label>
                            <select id="filter-risk" onchange="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none text-white font-bold">
                                <option value="all">الكل</option>
                                <option value="Low">Low Risk</option>
                                <option value="Medium">Medium Risk</option>
                                <option value="High">High Risk</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-500 uppercase tracking-widest mr-2">الربحية +%</label>
                            <input type="number" id="filter-profit-val" oninput="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-slate-500 uppercase tracking-widest mr-2">التمويل ($M)</label>
                            <input type="number" id="filter-funding-val" oninput="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none text-white">
                        </div>
                    </div>
                </div>

                <!-- جدول BI (يتحول لبطاقات في الجوال) -->
                <div class="bg-slate-900 rounded-[4rem] border border-white/5 overflow-hidden shadow-2xl relative">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-right responsive-table">
                            <thead class="bg-slate-950/80 text-slate-500 text-[10px] font-black uppercase tracking-[0.4em] italic">
                                <tr>
                                    <th class="p-8">الكيان الاستراتيجي</th>
                                    <th class="p-8 text-center">الربحية (%)</th>
                                    <th class="p-8 text-center">التمويل ($M)</th>
                                    <th class="p-8 text-center">المخاطرة</th>
                                    <th class="p-8 text-center">الحالة</th>
                                    <th class="p-8 text-center">إدارة القرار</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="divide-y divide-white/[0.03]"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- مركز الرسائل -->
        <section id="messages-page" class="page-section hidden min-h-screen bg-slate-50 py-16 px-6 text-right">
            <div class="container mx-auto max-w-7xl">
                <header class="mb-12 flex justify-between items-center">
                    <h2 class="text-4xl font-black italic tracking-tighter uppercase">Negotiation <span class="text-amber-500">Command</span></h2>
                    <button onclick="showPage('dashboard')" class="text-slate-400 font-bold flex items-center gap-2 italic uppercase text-[10px]">العودة <i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 bg-white rounded-[4rem] border shadow-2xl overflow-hidden min-h-[700px]">
                    <div class="border-l bg-slate-50/50 p-10 space-y-6 overflow-y-auto custom-scrollbar">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 italic">غرف العمليات النشطة</p>
                        <div id="chat-list" class="space-y-4"></div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col h-full bg-white relative">
                        <div id="active-chat-header" class="p-10 border-b flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-amber-500 rounded-2xl flex items-center justify-center font-black italic shadow-xl text-white text-xl">ك</div>
                                <div><p id="chat-target-name" class="text-lg font-black italic">اختر كيان لبدء التفاوض</p><p class="text-[10px] text-green-500 font-black italic uppercase">• تشفير سيادي مفعل</p></div>
                            </div>
                        </div>
                        <div id="chat-messages-container" class="grow p-10 overflow-y-auto space-y-10 bg-slate-50/30 flex flex-col justify-center items-center text-slate-300">
                            <p class="text-xl font-black italic opacity-50">يرجى اختيار مشروع لبدء المفاوضة</p>
                        </div>
                        <div class="p-10 border-t flex gap-4 bg-white items-center">
                            <input type="text" placeholder="اكتب عرضك المالي..." class="grow bg-slate-50 border border-slate-200 rounded-[2rem] px-8 py-4 text-sm font-bold outline-none focus:ring-1 focus:ring-amber-500">
                            <button class="bg-slate-950 text-white p-5 rounded-[2rem] shadow-xl hover:scale-110 transition-all"><i data-lucide="send" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- تسجيل المشروع (4 خطوات) -->
        <section id="form-page" class="page-section hidden py-16 bg-slate-50 min-h-screen">
            <div class="container mx-auto px-6 max-w-5xl">
                <div class="flex justify-between mb-24 relative px-10">
                    <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2 z-0"></div>
                    <div id="step-line" class="absolute top-1/2 right-0 w-0 h-1 bg-amber-500 -translate-y-1/2 z-0 transition-all duration-700"></div>
                    
                    <div class="relative z-10 flex flex-col items-center gap-4"><div class="step-dot w-12 h-12 rounded-full bg-amber-500 text-slate-950 flex items-center justify-center font-black ring-4 ring-white shadow-xl italic">1</div><span class="text-[9px] font-black uppercase text-amber-600 italic">ملف الكيان</span></div>
                    <div class="relative z-10 flex flex-col items-center gap-4"><div class="step-dot w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-black ring-4 ring-white italic">2</div><span class="text-[9px] font-black uppercase text-slate-400 italic">المالية</span></div>
                    <div class="relative z-10 flex flex-col items-center gap-4"><div class="step-dot w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-black ring-4 ring-white italic">3</div><span class="text-[9px] font-black uppercase text-slate-400 italic">الخطة</span></div>
                    <div class="relative z-10 flex flex-col items-center gap-4"><div class="step-dot w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-black ring-4 ring-white italic">4</div><span class="text-[9px] font-black uppercase text-slate-400 italic">التشخيص</span></div>
                </div>

                <div id="form-step-1" class="active-step bg-white rounded-[4rem] p-12 lg:p-16 shadow-2xl border text-right relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-2 h-full bg-amber-500/10"></div>
                    <h2 class="text-4xl font-black mb-12 border-b pb-8 italic">أولاً: الملف التعريفي والجيومكاني</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-3"><label class="text-[10px] font-black text-slate-500 uppercase italic">اسم المشروع</label><input type="text" id="f-name" class="w-full p-6 bg-slate-50 border border-slate-200 rounded-3xl outline-none font-bold text-lg focus:ring-1 focus:ring-amber-500"></div>
                        <div class="space-y-3"><label class="text-[10px] font-black text-slate-500 uppercase italic">القطاع الاستراتيجي</label><select id="f-sector" class="w-full p-6 bg-slate-50 border border-slate-200 rounded-3xl outline-none font-bold text-lg focus:ring-1 focus:ring-amber-500"></select></div>
                        <div class="space-y-3"><label class="text-[10px] font-black text-slate-500 uppercase italic">الدولة</label><input type="text" id="f-country" class="w-full p-6 bg-slate-50 border border-slate-200 rounded-3xl outline-none font-bold text-lg"></div>
                        <div class="space-y-3"><label class="text-[10px] font-black text-slate-500 uppercase italic">المدينة</label><input type="text" id="f-city" class="w-full p-6 bg-slate-50 border border-slate-200 rounded-3xl outline-none font-bold text-lg"></div>
                    </div>
                    <div class="flex justify-end mt-16"><button onclick="nextStep(2)" class="bg-slate-950 text-white px-16 py-6 rounded-3xl font-black shadow-xl hover:scale-105 transition-all text-sm uppercase">التالي</button></div>
                </div>

                <!-- الخطوة 4 (مصفوفة التشخيص) -->
                <div id="form-step-4" class="hidden bg-white rounded-[4rem] p-12 lg:p-16 shadow-2xl border text-right">
                    <h2 class="text-4xl font-black mb-12 text-center italic">مصفوفة التشخيص النهائي (5/5)</h2>
                    <div id="diagnosis-questions-container" class="space-y-8 mb-16"></div>
                    <div class="flex justify-between items-center mt-12 border-t pt-10">
                         <button onclick="nextStep(3)" class="text-slate-400 font-black px-10 italic uppercase text-[10px]">السابق</button>
                         <button onclick="submitDiagnostics()" class="bg-amber-500 text-slate-950 px-20 py-6 rounded-[2.5rem] font-black shadow-2xl hover:scale-105 transition-all text-xl italic uppercase">إرسال لـ Strategy BI</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- الخريطة -->
        <section id="map-page" class="page-section hidden py-24 admin-theme text-white min-h-screen px-8">
            <div class="container mx-auto text-center space-y-12">
                <header>
                    <h2 class="text-6xl font-black text-amber-500 italic mb-4 uppercase tracking-widest leading-none">Geospatial Asset Map</h2>
                    <p class="text-slate-500 font-bold uppercase text-[11px] tracking-[0.4em] italic">نظام التتبع الجغرافي للأصول المدارة</p>
                </header>
                <div id="project-map" class="shadow-2xl border border-white/5 relative z-10"></div>
            </div>
        </section>

    </main>

    <!-- المودال: تفاصيل الكيان -->
    <div id="details-modal" class="fixed inset-0 bg-slate-950/98 z-[10000] hidden items-center justify-center p-6 lg:p-16 backdrop-blur-3xl overflow-y-auto">
        <div class="bg-white rounded-[5rem] w-full max-w-7xl overflow-hidden shadow-2xl flex flex-col max-h-[95vh] text-right">
            <div id="modal-view-main" class="flex flex-col h-full">
                <div class="p-10 lg:p-14 bg-amber-500 flex justify-between items-center text-slate-950 shrink-0">
                    <div>
                        <span id="modal-status-badge" class="bg-slate-950 text-white text-[9px] px-5 py-2 rounded-full font-black uppercase mb-4 inline-block italic tracking-widest">تحليل استراتيجي مكتمل</span>
                        <h3 id="modal-title" class="text-4xl lg:text-5xl font-black tracking-tighter italic uppercase">ملف الكيان التفصيلي</h3>
                    </div>
                    <button onclick="closeModal()" class="w-16 h-16 bg-slate-950/10 rounded-[2.5rem] flex items-center justify-center hover:bg-slate-950/20 group transition-all">
                        <i data-lucide="x" class="w-8 h-8 group-hover:rotate-90"></i>
                    </button>
                </div>

                <div class="overflow-y-auto p-8 lg:p-16 grow space-y-16 custom-scrollbar">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                        <div class="lg:col-span-2 space-y-12">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6" id="modal-metrics-grid"></div>
                            <div class="bg-slate-50 p-10 rounded-[3rem] border shadow-inner">
                                <h4 class="font-black text-slate-900 text-2xl flex items-center gap-4 mb-8 italic"><i data-lucide="file-check" class="text-amber-500"></i> وثائق العناية الواجبة</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="p-6 bg-white border rounded-3xl flex justify-between items-center cursor-pointer hover:border-amber-500 transition-all group">
                                        <div class="flex items-center gap-4"><i data-lucide="file-bar-chart" class="text-blue-500"></i><p class="text-[10px] font-black">تقييم_الأصول_2025.pdf</p></div>
                                        <i data-lucide="download" class="w-4 h-4 text-slate-300 group-hover:text-amber-500"></i>
                                    </div>
                                    <div class="p-6 bg-white border rounded-3xl flex justify-between items-center cursor-pointer hover:border-amber-500 transition-all group">
                                        <div class="flex items-center gap-4"><i data-lucide="shield-check" class="text-green-500"></i><p class="text-[10px] font-black">سجل_الملكية_الفكرية.pdf</p></div>
                                        <i data-lucide="download" class="w-4 h-4 text-slate-300 group-hover:text-amber-500"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="admin-actions-sidebar" class="hidden space-y-8">
                            <div class="bg-slate-950 text-white p-10 rounded-[4rem] border border-white/5 space-y-8 shadow-2xl">
                                <h4 class="text-amber-500 font-black text-[10px] uppercase tracking-widest italic border-b border-white/10 pb-6 italic">إجراءات الإدارة</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="updateStatus('Pinned')" class="p-5 bg-white/5 border border-white/10 rounded-3xl hover:bg-amber-500 hover:text-slate-950 transition-all text-[9px] font-black uppercase italic">تثبيت <i data-lucide="pin" class="w-3 h-3 inline"></i></button>
                                    <button onclick="updateStatus('Rejected')" class="p-5 bg-white/5 border border-red-500/30 rounded-3xl text-[9px] font-black uppercase text-red-500 hover:bg-red-500 hover:text-white transition-all italic">رفض <i data-lucide="x-circle" class="w-3 h-3 inline"></i></button>
                                </div>
                                <hr class="opacity-5">
                                <button onclick="showAcquisitionRoom()" class="w-full bg-amber-500 text-slate-950 py-7 rounded-[2.5rem] font-black shadow-2xl hover:scale-105 transition-all text-xl italic uppercase">غرفة المفاوضات <i data-lucide="zap" class="inline w-6 h-6 ml-2"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- غرفة العمليات (War-Room) -->
            <div id="modal-view-acquisition" class="hidden flex flex-col h-full bg-slate-100">
                <div class="p-10 bg-slate-950 text-white flex justify-between items-center shrink-0 shadow-2xl">
                    <div class="flex items-center gap-8">
                        <button onclick="backToMainView()" class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center hover:bg-white/20 transition-all"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                        <div>
                            <h3 class="text-4xl font-black text-amber-500 italic uppercase">Asset <span class="text-white">War-Room</span></h3>
                            <p class="text-slate-500 text-[9px] font-black uppercase tracking-widest mt-2">نظام التفاوض المشفر والمؤمن V2.4</p>
                        </div>
                    </div>
                </div>

                <div id="acq-path-selection" class="p-12 lg:p-20 grow flex flex-col justify-center items-center gap-16 overflow-y-auto">
                    <h4 class="text-3xl font-black italic">اختر مسار الاستحواذ الاستراتيجي</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-5xl text-center">
                        <div onclick="activatePath('الاستحواذ الكلي')" class="p-12 bg-white rounded-[4rem] border cursor-pointer hover:border-amber-500 shadow-xl group transition-all duration-500">
                            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-8 group-hover:scale-110 transition-transform"><i data-lucide="landmark" class="w-10 h-10"></i></div>
                            <h4 class="font-black text-xl uppercase italic">الاستحواذ الكلي</h4>
                        </div>
                        <div onclick="activatePath('شراكة استراتيجية')" class="p-12 bg-white rounded-[4rem] border cursor-pointer hover:border-amber-500 shadow-xl group transition-all duration-500">
                            <div class="w-20 h-20 bg-amber-50 text-amber-600 rounded-3xl flex items-center justify-center mx-auto mb-8 group-hover:scale-110 transition-transform"><i data-lucide="users" class="w-10 h-10"></i></div>
                            <h4 class="font-black text-xl uppercase italic">شراكة استراتيجية</h4>
                        </div>
                        <div onclick="activatePath('وساطة سيادية')" class="p-12 bg-white rounded-[4rem] border cursor-pointer hover:border-amber-500 shadow-xl group transition-all duration-500">
                            <div class="w-20 h-20 bg-green-50 text-green-600 rounded-3xl flex items-center justify-center mx-auto mb-8 group-hover:scale-110 transition-transform"><i data-lucide="target" class="w-10 h-10"></i></div>
                            <h4 class="font-black text-xl uppercase italic">وساطة ومطابقة</h4>
                        </div>
                    </div>
                </div>

                <div id="acq-active-room" class="hidden p-8 lg:p-12 grow overflow-hidden flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-2/3 bg-white rounded-[4rem] shadow-xl flex flex-col overflow-hidden border border-slate-200">
                        <div id="chat-messages-live" class="grow p-10 overflow-y-auto space-y-8 custom-scrollbar bg-slate-50/20 italic font-bold text-center flex flex-col items-center justify-center text-slate-300">
                            اختر مسار الاستحواذ لبدء البروتوكول
                        </div>
                        <div class="p-8 border-t flex gap-4 bg-slate-50 items-center">
                            <input type="text" placeholder="اكتب عرضك النهائي..." class="grow bg-white border border-slate-200 rounded-[2rem] px-8 py-5 text-sm font-bold shadow-inner outline-none">
                            <button class="bg-slate-950 text-white p-5 rounded-[2rem] shadow-xl"><i data-lucide="send" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    <div class="lg:w-1/3 space-y-8">
                        <div class="bg-slate-950 text-white p-10 rounded-[4rem] shadow-xl space-y-8 border border-white/5">
                            <h4 class="font-black text-amber-500 text-[10px] uppercase tracking-widest italic border-b border-white/5 pb-6 italic">بروتوكولات الإغلاق</h4>
                            <div class="space-y-4">
                                <button onclick="simulateSend('MoU')" class="w-full bg-white/5 p-5 rounded-2xl text-[9px] font-black flex justify-between items-center hover:bg-white/10 transition-all uppercase italic">إصدار مذكرة تفاهم (MoU) <i data-lucide="scroll"></i></button>
                                <button onclick="updateStatus('تم الاستحواذ')" class="w-full bg-amber-500 text-slate-950 p-8 rounded-[2.5rem] font-black text-sm shadow-xl italic tracking-tighter uppercase italic">إتمام الاستحواذ ✅</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let userRole = 'user';
        let projects = [];
        let currentProjectId = null;
        let map, markersGroup;

        const SECTORS = [
            "الذكاء الاصطناعي والأتمتة", "الأمن السيبراني المتطور", "التقنيات المالية (FinTech)", "الخدمات اللوجستية الذكية", 
            "الطاقة المستدامة", "التقنيات الزراعية", "تكنولوجيا الرعاية الصحية", "التجارة الإلكترونية",
            "تكنولوجيا التعليم الرقمي", "الاقتصاد الأخضر", "العقارات الذكية", "البرمجيات السحابية",
            "تكنولوجيا الفضاء", "التقنية الحيوية", "تكنولوجيا الدفاع", "التصنيع المتقدم"
        ];

        const CITY_COORDS = { 
            "الرياض": [24.71, 46.67], "دبي": [25.20, 55.27], "جدة": [21.48, 39.19], 
            "القاهرة": [30.04, 31.23], "المنامة": [26.22, 50.58], "الكويت": [29.37, 47.97]
        };

        const REALISTIC_COMPANIES = [
            "سديم للحلول السحابية", "نماء للتقنيات الزراعية", "شركة مآل المالية", "أفق للخدمات اللوجستية",
            "روابي للطاقة المستدامة", "ثراء لأبحاث الذكاء", "درع للأمن السيبراني", "كيان للتجارة الرقمية",
            "جسور للتعليم التفاعلي", "إيكو-لوب للاقتصاد الأخضر", "مدار لأنظمة الفضاء", "أركان للتقنية العقارية",
            "إمداد لسلاسل التوريد", "نبراس للتقنية الحيوية", "صمود للأنظمة الدفاعية", "رعاية للأنظمة الصحية"
        ];

        const SMART_QUESTIONS = [
            { q:1, text: "المحرك الأساسي للقيمة المضافة؟", opts: [{v:"A", t:"أصول فيزيائية"}, {v:"B", t:"خوارزميات وبرمجيات"}, {v:"C", t:"بيانات وملكيات فكرية"}] },
            { q:2, text: "موديل التوسع الجغرافي؟", opts: [{v:"A", t:"فروع مادية"}, {v:"B", t:"رقمي تدريجي"}, {v:"C", t:"عالمي فوري"}] },
            { q:3, text: "درجة السيادة التقنية؟", opts: [{v:"A", t:"تبعية كاملة"}, {v:"B", t:"تبعية جزئية"}, {v:"C", t:"سيادة كاملة"}] }
        ];

        function seedData() {
            projects = [];
            const cities = Object.keys(CITY_COORDS);
            for(let i=1; i<=30; i++) {
                const city = cities[i % cities.length];
                const profit = 15 + Math.floor(Math.random() * 55);
                const funding = (Math.random() * 50 + 5).toFixed(1);
                projects.push({
                    id: i, name: REALISTIC_COMPANIES[i % REALISTIC_COMPANIES.length] + " " + (i),
                    sector: SECTORS[i % SECTORS.length], city: city, country: "السعودية", coords: CITY_COORDS[city],
                    profit: profit, funding: funding, risk: ["Low", "Medium", "High"][i % 3], teamRating: (Math.random()*2+3).toFixed(1),
                    status: 'نشط', alignment: (Math.random()*15+82).toFixed(1)
                });
            }
        }

        function init() {
            seedData();
            const filSector = document.getElementById('filter-sector');
            const fSector = document.getElementById('f-sector');
            if(filSector) filSector.innerHTML = '<option value="all">كافة القطاعات</option>';
            SECTORS.forEach(s => {
                const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
                if(filSector) filSector.appendChild(opt.cloneNode(true));
                if(fSector) fSector.appendChild(opt);
            });

            const qContainer = document.getElementById('diagnosis-questions-container');
            if(qContainer) {
                SMART_QUESTIONS.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-slate-50 p-10 rounded-[3rem] border shadow-sm";
                    div.innerHTML = `<p class="font-black text-slate-800 mb-8 italic text-xl border-r-8 border-amber-500 pr-6">${item.text}</p><div class="grid grid-cols-1 md:grid-cols-3 gap-6">${item.opts.map(o => `<label class="flex items-center gap-6 p-6 bg-white rounded-[2rem] border-2 cursor-pointer hover:border-amber-500 font-black text-xs shadow-sm"><input type="radio" name="q${item.q}" value="${o.v}" class="w-6 h-6 accent-amber-500"> ${o.t}</label>`).join('')}</div>`;
                    qContainer.appendChild(div);
                });
            }

            const sectorRef = document.getElementById('sectors-ref-container');
            if(sectorRef) {
                SECTORS.slice(0, 8).forEach(s => {
                    const div = document.createElement('div');
                    div.className = "bg-slate-50 p-10 rounded-[3rem] border group hover:bg-white hover:shadow-2xl transition-all text-right";
                    div.innerHTML = `<h4 class="font-black text-slate-800 mb-3 italic text-xl">${s}</h4><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest italic leading-loose">تحليل الأصول والبيانات الاستراتيجية</p>`;
                    sectorRef.appendChild(div);
                });
            }

            initMap();
            applyFilters();
            renderInvestorMatches();
            renderChatList();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            const el = document.getElementById(`${id}-page`);
            if(el) {
                el.classList.add('active-section'); 
                el.classList.remove('hidden');
            }
            if(id === 'map' && map) setTimeout(() => map.invalidateSize(), 400);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function setRole(role) {
            userRole = role;
            ['user', 'inv', 'adm'].forEach(r => {
                const btn = document.getElementById(`role-${r}-btn`);
                if(btn) btn.className = r === role ? "px-5 py-2 rounded-full text-[8px] font-black transition-all bg-white shadow-xl text-slate-900 border" : "px-5 py-2 rounded-full text-[8px] font-black transition-all text-slate-400";
            });
            document.getElementById('nav-inv-btn').classList.toggle('hidden', role !== 'investor');
            document.getElementById('nav-adm-btn').classList.toggle('hidden', role !== 'admin');
            document.getElementById('nav-msg-btn').classList.toggle('hidden', role !== 'admin');
            if(role === 'admin') showPage('dashboard'); 
            else if(role === 'investor') showPage('inv-dash'); 
            else showPage('landing');
            showNotification(`تم تغيير الصلاحية بنجاح`);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
        }

        function applyFilters() {
            const search = document.getElementById('filter-search')?.value.toLowerCase() || "";
            const sector = document.getElementById('filter-sector')?.value || "all";
            const risk = document.getElementById('filter-risk')?.value || "all";
            const profitVal = parseFloat(document.getElementById('filter-profit-val')?.value) || 0;
            const fundingVal = parseFloat(document.getElementById('filter-funding-val')?.value) || Infinity;

            const filtered = projects.filter(p => {
                const sMatch = p.name.toLowerCase().includes(search) || p.city.toLowerCase().includes(search);
                const sectorMatch = sector === 'all' || p.sector === sector;
                const riskMatch = risk === 'all' || p.risk === risk;
                const profitMatch = p.profit >= profitVal;
                const fundingMatch = parseFloat(p.funding) <= fundingVal;
                return sMatch && sectorMatch && riskMatch && profitMatch && fundingMatch;
            });

            renderTable(filtered);
            updateStats(filtered);
            renderMapMarkers(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('admin-table-body');
            if(!tbody) return;
            tbody.innerHTML = data.map(p => `
                <tr class="hover:bg-white/[0.04] transition-all group">
                    <td class="p-8" data-label="الكيان"><div class="val-content"><div class="font-black text-slate-100 italic text-lg">${p.name}</div><div class="text-[9px] text-amber-500 font-black uppercase mt-1">${p.sector}</div></div></td>
                    <td class="p-8 text-center" data-label="الربحية"><div class="val-content font-black text-amber-500 text-3xl italic">${p.profit}%</div></td>
                    <td class="p-8 text-center" data-label="التمويل"><div class="val-content font-black text-slate-300 italic text-2xl">$${p.funding}M</div></td>
                    <td class="p-8 text-center" data-label="المخاطرة"><div class="val-content"><span class="px-4 py-2 rounded-full text-[9px] font-black border ${p.risk==='Low'?'border-green-500 text-green-500':'border-amber-500 text-amber-500'} italic">${p.risk}</span></div></td>
                    <td class="p-8 text-center" data-label="الحالة"><div class="val-content"><span class="text-[9px] font-black px-4 py-2 bg-white/5 rounded-full text-green-500 uppercase italic">${p.status}</span></div></td>
                    <td class="p-8 text-center" data-label="الإجراء"><div class="val-content"><button onclick="viewProject(${p.id})" class="bg-white/5 p-4 rounded-3xl text-amber-500 hover:scale-125 transition-transform"><i data-lucide="microscope" class="w-8 h-8"></i></button></div></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function updateStats(data) {
            const t = data.length;
            const funding = data.reduce((a, b) => a + parseFloat(b.funding), 0).toFixed(0);
            const profit = t > 0 ? (data.reduce((a, b) => a + b.profit, 0) / t).toFixed(1) : 0;
            const team = t > 0 ? (data.reduce((a, b) => a + parseFloat(b.teamRating), 0) / t).toFixed(1) : 0;
            if(document.getElementById('stat-total')) document.getElementById('stat-total').textContent = t;
            if(document.getElementById('stat-total-funding')) document.getElementById('stat-total-funding').textContent = `$${funding}M`;
            if(document.getElementById('stat-avg-profit')) document.getElementById('stat-avg-profit').textContent = `${profit}%`;
            if(document.getElementById('stat-avg-team')) document.getElementById('stat-avg-team').textContent = `${team}/5`;
        }

        function renderInvestorMatches() {
            const container = document.getElementById('investor-match-list');
            if(!container) return;
            const matches = projects.sort((a,b) => b.alignment - a.alignment).slice(0, 10);
            container.innerHTML = matches.map(p => `
                <div class="flex flex-col lg:flex-row items-center justify-between p-10 glass-card rounded-[4rem] hover:bg-white/10 transition-all gap-8 shadow-2xl">
                    <div class="flex items-center gap-10 text-right">
                        <div class="w-24 h-24 bg-green-500/20 text-green-400 rounded-[2.5rem] flex items-center justify-center font-black text-3xl shadow-xl">${p.alignment}%</div>
                        <div><h4 class="font-black text-3xl italic">${p.name}</h4><p class="text-[10px] text-slate-500 font-black uppercase mt-2">${p.sector} • ${p.city}</p></div>
                    </div>
                    <div class="flex flex-wrap items-center gap-12">
                        <div class="text-center border-r border-white/10 pr-12"><p class="text-[9px] text-slate-500 font-black mb-1 uppercase">رأس المال</p><p class="text-white font-black text-2xl italic">$${p.funding}M</p></div>
                        <button onclick="viewProject(${p.id})" class="bg-green-500 text-slate-950 px-12 py-5 rounded-[2rem] font-black text-sm uppercase shadow-xl hover:scale-110 transition-all">تحليل</button>
                    </div>
                </div>
            `).join('');
        }

        function initMap() {
            const mapEl = document.getElementById('project-map');
            if(!mapEl || map) return;
            map = L.map('project-map').setView([24, 45], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            markersGroup = L.layerGroup().addTo(map);
        }

        function renderMapMarkers(data) {
            if(!markersGroup) return;
            markersGroup.clearLayers();
            data.forEach(p => {
                const icon = L.divIcon({ className: 'custom-icon', html: `<div style="background:#f59e0b;width:18px;height:18px;border:3px solid white;border-radius:50%;box-shadow:0 0 15px #f59e0b"></div>`, iconSize: [18, 18] });
                if(p.coords) L.marker(p.coords, { icon: icon }).addTo(markersGroup).bindPopup(`<div class="text-right font-black italic p-4"><p class="text-amber-500 mb-4 text-xl font-black">${p.name}</p><button onclick="viewProject(${p.id})" class="w-full py-2 bg-amber-500 rounded-xl text-slate-950 text-[10px] font-black">تحليل BI</button></div>`);
            });
        }

        function viewProject(id) {
            currentProjectId = id;
            const p = projects.find(x => x.id == id);
            if(!p) return;
            document.getElementById('modal-title').textContent = p.name;
            document.getElementById('modal-status-badge').textContent = `حالة الكيان: ${p.status}`;
            document.getElementById('modal-metrics-grid').innerHTML = `
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border shadow-sm"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest">الموقع</span><p class="font-black text-slate-900 text-2xl">${p.city}</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border shadow-sm"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest">الربحية</span><p class="font-black text-amber-600 text-4xl italic">${p.profit}%</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border shadow-sm"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest">التمويل</span><p class="font-black text-slate-900 text-3xl italic">$${p.funding}M</p></div>
            `;
            document.getElementById('admin-actions-sidebar').classList.toggle('hidden', userRole !== 'admin');
            backToMainView();
            document.getElementById('details-modal').classList.remove('hidden');
            document.getElementById('details-modal').classList.add('flex');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('details-modal').classList.add('hidden'); }
        function showAcquisitionRoom() { document.getElementById('modal-view-main').classList.add('hidden'); document.getElementById('modal-view-acquisition').classList.remove('hidden'); lucide.createIcons(); }
        function backToMainView() { document.getElementById('modal-view-acquisition').classList.add('hidden'); document.getElementById('modal-view-main').classList.remove('hidden'); document.getElementById('acq-path-selection').classList.remove('hidden'); document.getElementById('acq-active-room').classList.add('hidden'); }
        
        function activatePath(path) {
            document.getElementById('acq-path-selection').classList.add('hidden');
            document.getElementById('acq-active-room').classList.remove('hidden');
            const msgLive = document.getElementById('chat-messages-live');
            msgLive.innerHTML = `<div class="flex flex-col gap-6 w-full"><div class="flex justify-start"><div class="chat-received p-8 max-w-[85%] text-sm font-bold italic">تم تفعيل مسار [${path}]. ننتظر عرضكم الأول لبدء المفاوضات السيادية.</div></div></div>`;
            lucide.createIcons();
        }

        function updateStatus(status) { 
            const p = projects.find(x => x.id == currentProjectId); 
            if(p) { p.status = status; showNotification(`تم تحديث الحالة: ${status}`); viewProject(currentProjectId); applyFilters(); } 
        }

        function simulateSend(type) { 
            showNotification(`جاري إرسال بروتوكول ${type}...`); 
            setTimeout(() => showNotification(`تم الإرسال بنجاح ✅`), 2000); 
        }

        function renderChatList() {
            const container = document.getElementById('chat-list');
            if(!container) return;
            container.innerHTML = projects.slice(0, 12).map(p => `
                <div onclick="openChat(${p.id})" class="p-6 bg-white border border-slate-100 rounded-[2.5rem] flex items-center gap-6 cursor-pointer hover:border-amber-500 shadow-sm group">
                    <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center font-black italic text-xs group-hover:bg-amber-500 transition-colors">${p.name[0]}</div>
                    <div class="grow overflow-hidden text-right">
                        <p class="text-sm font-black truncate">${p.name}</p>
                        <p class="text-[9px] text-slate-400 font-bold italic truncate uppercase tracking-widest mt-1">تفاوض نشط</p>
                    </div>
                </div>
            `).join('');
        }

        function openChat(id) {
            const p = projects.find(x => x.id == id);
            document.getElementById('chat-target-name').textContent = p.name;
            const msgContainer = document.getElementById('chat-messages-container');
            msgContainer.className = "grow p-10 overflow-y-auto space-y-10 bg-slate-50/10";
            msgContainer.innerHTML = `
                <div class="flex justify-start"><div class="chat-received p-8 max-w-[85%] text-sm font-bold shadow-xl italic">أهلاً فريق كنوز. نود مناقشة الاستحواذ على كيان [${p.name}].</div></div>
                <div class="flex justify-end"><div class="chat-sent p-8 max-w-[85%] text-sm font-black shadow-xl italic">مرحباً. تم استلام الطلب، جاري مراجعة البيانات عبر BI والرد خلال 24 ساعة.</div></div>
            `;
            showPage('messages');
        }

        function fillDefaultFormData() {
            document.getElementById('f-name').value = "سديم للحلول المتقدمة";
            document.getElementById('f-sector').value = "الذكاء الاصطناعي والأتمتة";
            document.getElementById('f-country').value = "المملكة العربية السعودية";
            document.getElementById('f-city').value = "الرياض";
            document.querySelectorAll('input[type="radio"]').forEach((el, i) => { if((i+1)%3 === 0) el.checked = true; });
        }

        function nextStep(s) { 
            document.querySelectorAll('[id^="form-step-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`form-step-${s}`).classList.remove('hidden');
            document.getElementById('step-line').style.width = `${(s-1)*33.33}%`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function submitDiagnostics() {
            document.getElementById('loading-screen').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                showNotification("تم إرسال المشروع للتحليل الاستراتيجي بنجاح");
                showPage('ent-dash');
                nextStep(1);
            }, 3000);
        }

        function showNotification(text) { 
            const toast = document.getElementById('notification'); 
            document.getElementById('notification-text').textContent = text; 
            toast.classList.add('show'); 
            setTimeout(() => toast.classList.remove('show'), 4500); 
        }

        window.onload = init;
    </script>
</body>
</html>
