<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة كنوز | النظام الاستراتيجي الشامل</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; scroll-behavior: smooth; overflow-x: hidden; background-color: #f8fafc; }
        .hidden { display: none; }
        .active-section { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 10px; }
        
        /* Glassmorphism */
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .admin-theme { background-color: #020617; color: white; }
        
        /* Progress Ring */
        .progress-ring { transition: stroke-dashoffset 0.5s ease; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* Table Responsiveness Hack */
        @media (max-width: 1024px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 1.5rem; padding: 1rem; border: 1px solid rgba(255,255,255,0.1); }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: left; font-size: 0.85rem; }
            .responsive-table td:last-child { border: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 900; color: #64748b; font-size: 0.7rem; text-transform: uppercase; margin-left: 1rem; }
        }

        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120px); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; }
        #notification.show { transform: translateX(-50%) translateY(0); }
        
        /* Map responsiveness */
        #project-map { height: 400px; width: 100%; border-radius: 2rem; }
        @media (min-width: 1024px) { #project-map { height: 600px; } }
    </style>
</head>
<body class="text-slate-900 bg-slate-50">

    <!-- Global Loading Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-950 z-[9999] hidden flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-white font-black italic tracking-widest">Kunuz Strategy Engine...</p>
    </div>

    <!-- Global Notification -->
    <div id="notification" class="bg-slate-950 text-white px-8 py-5 rounded-3xl shadow-2xl border border-white/10 flex items-center gap-4 min-w-[320px]">
        <div class="w-10 h-10 bg-amber-500 rounded-2xl flex items-center justify-center text-slate-950 shadow-lg"><i data-lucide="info" class="w-5 h-5"></i></div>
        <div><p id="notification-text" class="text-xs font-black italic">تم تنفيذ الإجراء بنجاح</p></div>
    </div>

    <!-- Navigation Bar -->
    <nav class="fixed top-0 w-full z-[100] bg-white/90 backdrop-blur-xl border-b border-slate-100 px-4 lg:px-12 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3 cursor-pointer" onclick="showPage('landing')">
            <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-slate-950 font-black text-xl">ك</div>
            <div class="hidden xs:block leading-none">
                <span class="text-xl font-black text-slate-950 block tracking-tighter uppercase">Kunuz <span class="text-amber-600 italic">Enterprise</span></span>
                <span class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">Global Asset Intelligence</span>
            </div>
        </div>
        
        <!-- Desktop Menu -->
        <div class="hidden lg:flex items-center gap-8 text-slate-600 font-black text-[10px] uppercase tracking-widest">
            <button onclick="showPage('landing')" class="hover:text-amber-500 transition-colors">الرئيسية</button>
            <button id="nav-ent-btn" onclick="showPage('ent-dash')" class="flex items-center gap-2 hover:text-amber-500"><i data-lucide="rocket" class="w-3 h-3"></i> الرائد</button>
            <button id="nav-inv-btn" onclick="showPage('inv-dash')" class="hidden items-center gap-2 text-green-600"><i data-lucide="trending-up" class="w-3 h-3"></i> المستثمر</button>
            <button id="nav-adm-btn" onclick="showPage('dashboard')" class="hidden items-center gap-2 text-blue-600"><i data-lucide="bar-chart-3" class="w-3 h-3"></i> Strategy BI</button>
            <button id="nav-msg-btn" onclick="showPage('messages')" class="hidden items-center gap-2 text-slate-500"><i data-lucide="mail" class="w-3 h-3"></i> الرسائل</button>
        </div>

        <div class="flex items-center gap-3">
            <div id="role-switcher" class="bg-slate-100 p-1 rounded-full flex gap-1 border">
                <button onclick="setRole('user')" id="role-user-btn" class="px-3 md:px-5 py-1.5 rounded-full text-[9px] font-black transition-all bg-white shadow-sm text-slate-900 border">رائد</button>
                <button onclick="setRole('investor')" id="role-inv-btn" class="px-3 md:px-5 py-1.5 rounded-full text-[9px] font-black transition-all text-slate-400">مستثمر</button>
                <button onclick="setRole('admin')" id="role-adm-btn" class="px-3 md:px-5 py-1.5 rounded-full text-[9px] font-black transition-all text-slate-400">إدارة</button>
            </div>
            <!-- Mobile Menu Toggle -->
            <button class="lg:hidden p-2 bg-slate-100 rounded-xl" onclick="toggleMobileMenu()"><i data-lucide="menu" class="w-5 h-5"></i></button>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 bg-slate-950/95 z-[150] hidden flex-col items-center justify-center text-white gap-8 font-black text-xl italic uppercase">
        <button onclick="toggleMobileMenu()" class="absolute top-6 right-6 p-4"><i data-lucide="x" class="w-8 h-8"></i></button>
        <button onclick="showPage('landing'); toggleMobileMenu()">الرئيسية</button>
        <button onclick="showPage('ent-dash'); toggleMobileMenu()">لوحة الرائد</button>
        <button id="mob-inv-btn" class="hidden text-green-500" onclick="showPage('inv-dash'); toggleMobileMenu()">لوحة المستثمر</button>
        <button id="mob-adm-btn" class="hidden text-blue-500" onclick="showPage('dashboard'); toggleMobileMenu()">Strategy BI</button>
        <button id="mob-msg-btn" class="hidden" onclick="showPage('messages'); toggleMobileMenu()">مركز الرسائل</button>
    </div>

    <main class="mt-[85px]">
        
        <!-- PAGE: LANDING -->
        <section id="landing-page" class="page-section active-section">
            <div class="relative py-24 lg:py-48 px-6 bg-slate-950 text-white min-h-[90vh] flex items-center overflow-hidden">
                <div class="container mx-auto grid lg:grid-cols-2 gap-16 items-center relative z-10">
                    <div class="text-right">
                        <span class="inline-block px-4 py-1 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-500 text-[10px] font-black uppercase mb-6 italic tracking-widest">Intelligent Acquisition Ecosystem</span>
                        <h1 class="text-5xl lg:text-8xl font-black mb-8 leading-[0.85] tracking-tighter italic">أصولك <br><span class="text-amber-500">استراتيجية</span> رقمية</h1>
                        <p class="text-slate-400 text-lg mb-12 max-w-lg font-light leading-relaxed">منصة "كنوز" تدمج تحليل البيانات الضخمة (Strategy BI) مع مصفوفة التشخيص لربط المشاريع العملاقة بكبار المستثمرين.</p>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="showPage('form')" class="bg-amber-500 text-slate-950 px-10 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 transition-all text-xs italic uppercase">ابدأ رحلة التمويل</button>
                            <button onclick="setRole('admin')" class="bg-white/5 border border-white/10 px-8 py-5 rounded-2xl font-bold backdrop-blur-md text-xs italic">استعرض Strategy BI</button>
                        </div>
                    </div>
                    <div class="hidden lg:block">
                        <div class="glass-card rounded-[4rem] p-12 border border-white/10 shadow-2xl">
                            <h3 class="text-amber-500 font-black text-xs uppercase tracking-widest mb-10 italic">Live BI Monitor</h3>
                            <div class="space-y-10">
                                <div class="flex justify-between items-end"><p class="text-slate-500 text-[10px] font-black uppercase">Investor Match-Rate</p><p class="text-4xl font-black tracking-tighter">96.4%</p></div>
                                <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden"><div class="h-full bg-amber-500 w-[96%] animate-pulse"></div></div>
                                <div class="flex justify-between items-end"><p class="text-slate-500 text-[10px] font-black uppercase">Managed Asset Flow</p><p class="text-4xl font-black tracking-tighter text-blue-400 italic">+$1.4B</p></div>
                                <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden"><div class="h-full bg-blue-500 w-[82%]"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="py-24 bg-white px-6">
                <div class="container mx-auto">
                    <h2 class="text-4xl font-black text-slate-900 mb-20 tracking-tighter text-center italic">القطاعات الاستراتيجية المشمولة</h2>
                    <div id="sectors-ref-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
                </div>
            </div>
        </section>

        <!-- PAGE: ENTREPRENEUR DASHBOARD -->
        <section id="ent-dash-page" class="page-section hidden py-16 px-6 text-right">
            <div class="container mx-auto max-w-6xl">
                <header class="mb-12 flex flex-col md:flex-row justify-between items-end gap-6">
                    <div>
                        <h2 class="text-4xl font-black tracking-tighter italic uppercase tracking-widest">Growth <span class="text-amber-500">Center</span></h2>
                        <p class="text-slate-400 text-[10px] font-black mt-2 italic">تتبع تقدم مشروعك ومواءمة المستثمرين</p>
                    </div>
                    <div class="bg-white px-6 py-3 rounded-2xl border shadow-sm text-xs font-black text-green-500 italic">جاري المراجعة الاستراتيجية</div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                    <div class="bg-white p-12 rounded-[3.5rem] shadow-xl border flex flex-col items-center justify-center text-center">
                        <div class="relative w-48 h-48 mb-6">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-slate-100" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                                <circle class="text-amber-500 progress-ring" id="ready-progress-ent" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="60" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-4xl font-black italic">76%</span>
                                <span class="text-[8px] font-black text-slate-400 uppercase mt-1">Gaining Readiness</span>
                            </div>
                        </div>
                        <h4 class="font-black text-slate-800 text-sm italic">بانتظار توقيع مذكرة التفاهم (MoU)</h4>
                    </div>

                    <div class="lg:col-span-2 bg-white p-10 rounded-[3.5rem] shadow-xl border overflow-hidden">
                        <div class="flex justify-between items-center mb-10">
                            <h4 class="font-black text-lg italic tracking-tighter">التدفقات المالية والنمو (Quarterly)</h4>
                            <span class="text-[9px] font-black text-slate-400 uppercase italic">Real-time Metrics</span>
                        </div>
                        <div class="h-40 flex items-end gap-3 px-4" id="sales-flow-bars-ent">
                            <div class="bg-slate-100 w-full rounded-t-xl h-[30%]"></div>
                            <div class="bg-slate-100 w-full rounded-t-xl h-[45%]"></div>
                            <div class="bg-amber-500 w-full rounded-t-xl h-[85%] shadow-lg shadow-amber-500/20 animate-pulse"></div>
                            <div class="bg-slate-100 w-full rounded-t-xl h-[55%]"></div>
                            <div class="bg-slate-100 w-full rounded-t-xl h-[75%]"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-slate-950 text-white p-10 rounded-[2.5rem] flex items-center gap-6 shadow-2xl">
                        <div class="w-12 h-12 bg-amber-500 rounded-2xl flex items-center justify-center text-slate-950 shadow-lg"><i data-lucide="users"></i></div>
                        <div><p class="text-[8px] text-slate-500 font-black uppercase mb-1">المستثمرون المهتمون</p><p class="text-2xl font-black italic">14 جهة</p></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] border flex items-center gap-6">
                        <div class="w-12 h-12 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center"><i data-lucide="target"></i></div>
                        <div><p class="text-[8px] text-slate-400 font-black uppercase mb-1">المواءمة الاستراتيجية</p><p class="text-2xl font-black italic">92%</p></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] border flex items-center gap-6">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center"><i data-lucide="clock"></i></div>
                        <div><p class="text-[8px] text-slate-400 font-black uppercase mb-1">الموعد القادم</p><p class="text-2xl font-black italic tracking-tighter italic">MoU Review</p></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE: INVESTOR DASHBOARD -->
        <section id="inv-dash-page" class="page-section hidden min-h-screen admin-theme py-16 px-6 text-right">
            <div class="container mx-auto">
                <header class="mb-16 flex flex-col lg:flex-row justify-between items-end gap-10">
                    <div>
                        <h2 class="text-5xl font-black tracking-tighter uppercase italic tracking-widest text-green-500 italic">Investor <span class="text-white">Universe</span></h2>
                        <p class="text-slate-500 text-[10px] font-black uppercase mt-4 tracking-[0.3em] italic">Portfolio Management & Pipeline Control</p>
                    </div>
                    <div class="bg-white/5 p-5 rounded-[2.5rem] border border-white/10 flex gap-8 text-[10px] font-black">
                        <div><span class="text-slate-500 ml-2">Available:</span><span class="text-green-400">$320M</span></div>
                        <div class="border-r border-white/10 pr-8"><span class="text-slate-500 ml-2">Pipeline:</span><span class="text-amber-400">12 Projects</span></div>
                    </div>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-16 text-right">
                    <div class="glass-card p-10 rounded-[3.5rem] border-r-4 border-r-green-500">
                        <p class="text-[9px] text-slate-500 font-black mb-3 uppercase italic">ROI Average</p>
                        <h3 class="text-5xl font-black text-green-400 italic tracking-tighter">28.4%</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3.5rem] border-r-4 border-r-amber-500">
                        <p class="text-[9px] text-slate-500 font-black mb-3 uppercase italic">Live Pipeline</p>
                        <h3 class="text-5xl font-black text-amber-500 italic tracking-tighter">6 Active</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3.5rem] border-r-4 border-r-blue-500">
                        <p class="text-[9px] text-slate-500 font-black mb-3 uppercase italic">Total Asset Value</p>
                        <h3 class="text-5xl font-black text-blue-400 italic tracking-tighter">$92M</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3.5rem] border-r-4 border-r-purple-500">
                        <p class="text-[9px] text-slate-500 font-black mb-3 uppercase italic">Risk Sentiment</p>
                        <h3 class="text-5xl font-black text-purple-400 italic tracking-tighter">Low</h3>
                    </div>
                </div>

                <div class="bg-slate-900/50 rounded-[4rem] border border-white/5 p-10 shadow-2xl">
                    <h4 class="font-black text-2xl mb-12 italic tracking-tighter flex items-center gap-4 italic"><i data-lucide="sparkles" class="text-green-400"></i> الفرص المفلترة بالذكاء الاصطناعي</h4>
                    <div id="investor-match-list" class="space-y-6"></div>
                </div>
            </div>
        </section>

        <!-- PAGE: ADMIN STRATEGY BI -->
        <section id="dashboard-page" class="page-section hidden min-h-screen admin-theme py-16 px-6 text-right">
            <div class="container mx-auto">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-16 gap-8">
                    <div>
                        <h2 class="text-6xl font-black tracking-tighter italic uppercase text-blue-500 italic">Strategy <span class="text-white">BI</span></h2>
                        <p class="text-slate-500 text-[10px] font-black mt-3 uppercase tracking-[0.4em] italic leading-loose">The Sovereign Intelligence & Massive Asset Control Center</p>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="window.print()" class="bg-white/5 border border-white/10 px-8 py-4 rounded-2xl text-[9px] font-black uppercase italic hover:bg-white/10 transition-all"><i data-lucide="file-down" class="inline w-3 h-3 ml-2"></i> BI Report</button>
                        <button onclick="showPage('map')" class="bg-blue-600 px-10 py-4 rounded-2xl font-black text-xs shadow-xl italic tracking-tighter">خارطة التدفقات</button>
                    </div>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
                    <div class="glass-card p-10 rounded-[3rem] border-t-2 border-t-blue-500">
                        <p class="text-[9px] text-slate-500 font-black mb-2 uppercase italic">الفرص النشطة</p>
                        <h3 id="stat-total" class="text-5xl font-black italic tracking-tighter text-white">0</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-t-2 border-t-green-500">
                        <p class="text-[9px] text-slate-500 font-black mb-2 uppercase italic">السيولة المستهدفة</p>
                        <h3 id="stat-total-funding" class="text-4xl font-black text-white">$0M</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-t-2 border-t-amber-500">
                        <p class="text-[9px] text-slate-500 font-black mb-2 uppercase italic">متوسط الربحية</p>
                        <h3 id="stat-avg-profit" class="text-5xl font-black italic text-white tracking-tighter">0%</h3>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] border-t-2 border-t-purple-500">
                        <p class="text-[9px] text-slate-500 font-black mb-2 uppercase italic">كفاءة الفريق</p>
                        <h3 id="stat-avg-team" class="text-5xl font-black italic text-white tracking-tighter">0/5</h3>
                    </div>
                </div>

                <div class="bg-white/5 p-8 lg:p-12 rounded-[4rem] border border-white/10 mb-12 backdrop-blur-xl">
                    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-6 items-end text-right text-[10px] font-black italic">
                        <div class="lg:col-span-2">
                            <label class="text-slate-400 uppercase tracking-widest ml-2 mb-2 block">البحث الاستراتيجي العميق</label>
                            <input type="text" id="filter-search" oninput="applyFilters()" placeholder="ابحث باسم الكيان أو المدينة..." class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none focus:ring-1 focus:ring-amber-500 text-white font-bold">
                        </div>
                        <div>
                            <label class="text-slate-400 uppercase tracking-widest ml-2 mb-2 block">القطاع</label>
                            <select id="filter-sector" onchange="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-5 py-4 outline-none text-white font-bold"></select>
                        </div>
                        <div>
                            <label class="text-slate-400 uppercase tracking-widest ml-2 mb-2 block">المخاطرة</label>
                            <select id="filter-risk" onchange="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-5 py-4 outline-none text-white font-bold">
                                <option value="all">الكل</option>
                                <option value="Low">Low Risk</option>
                                <option value="Medium">Medium Risk</option>
                                <option value="High">High Risk</option>
                            </select>
                        </div>
                        <div><label class="text-slate-400 uppercase tracking-widest ml-2 mb-2 block">الربحية (+%)</label><input type="number" id="filter-profit-val" oninput="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-5 py-4 outline-none text-white"></div>
                        <div><label class="text-slate-400 uppercase tracking-widest ml-2 mb-2 block">التمويل ($M)</label><input type="number" id="filter-funding-val" oninput="applyFilters()" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-5 py-4 outline-none text-white"></div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-[4rem] border border-white/5 overflow-hidden shadow-2xl relative">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-right responsive-table">
                            <thead class="bg-slate-950/80 text-slate-500 text-[9px] font-black uppercase tracking-[0.3em] italic">
                                <tr>
                                    <th class="p-8">الكيان الاستراتيجي</th>
                                    <th class="p-8 text-center">الربحية (%)</th>
                                    <th class="p-8 text-center">التمويل ($M)</th>
                                    <th class="p-8 text-center">المخاطرة</th>
                                    <th class="p-8 text-center">الحالة</th>
                                    <th class="p-8 text-center">إدارة القرار</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="divide-y divide-white/[0.03]"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE: MESSAGES -->
        <section id="messages-page" class="page-section hidden min-h-screen bg-slate-50 py-16 px-6 text-right">
            <div class="container mx-auto max-w-6xl">
                <header class="mb-12 flex justify-between items-center">
                    <h2 class="text-3xl font-black italic tracking-tighter uppercase tracking-widest">Negotiation <span class="text-amber-500 italic">Command</span></h2>
                    <button onclick="showPage('dashboard')" class="text-slate-400 font-bold flex items-center gap-2 italic text-[10px] tracking-widest uppercase"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to BI Terminal</button>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 bg-white rounded-[4rem] border shadow-2xl overflow-hidden min-h-[700px]">
                    <div class="border-l bg-slate-50/50 p-10 space-y-6 overflow-y-auto custom-scrollbar">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 italic">قائمة غرف التفاوض</p>
                        <div id="chat-list" class="space-y-4"></div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col h-full bg-white">
                        <div id="active-chat-header" class="p-10 border-b flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-amber-500 rounded-full flex items-center justify-center font-black italic shadow-xl">K</div>
                                <div><p id="chat-target-name" class="text-sm font-black italic uppercase">حدد كيان للبدء</p><p class="text-[9px] text-green-500 font-bold italic">• Online System Now</p></div>
                            </div>
                        </div>
                        <div id="chat-messages-container" class="grow p-12 overflow-y-auto space-y-8 custom-scrollbar bg-slate-50/20 italic font-bold text-slate-300 text-center flex items-center justify-center text-xl">
                            اختر مشروعاً لبدء المفاوضة الاستراتيجية
                        </div>
                        <div class="p-10 border-t flex gap-4 shrink-0 bg-white">
                            <input type="text" placeholder="اكتب العرض المالي أو شروط الاستحواذ..." class="grow bg-slate-50 border rounded-2xl px-6 py-4 text-xs font-bold outline-none focus:ring-1 focus:ring-amber-500">
                            <button class="bg-slate-950 text-white px-8 py-4 rounded-2xl shadow-xl"><i data-lucide="send"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE: FORM -->
        <section id="form-page" class="page-section hidden py-20 bg-slate-50 min-h-screen">
            <div class="container mx-auto px-6 max-w-5xl">
                <div class="flex justify-between mb-20 relative px-10">
                    <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2 z-0"></div>
                    <div id="step-line" class="absolute top-1/2 left-0 w-0 h-1 bg-amber-500 -translate-y-1/2 z-0 transition-all duration-500"></div>
                    <div class="relative z-10 flex flex-col items-center gap-2"><div class="step-dot w-12 h-12 rounded-full bg-amber-500 text-slate-950 flex items-center justify-center font-black ring-4 ring-white shadow-xl italic">1</div><span class="hidden sm:block text-[9px] font-black uppercase text-amber-600 italic tracking-widest">الكيان</span></div>
                    <div class="relative z-10 flex flex-col items-center gap-2"><div class="step-dot w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-black ring-4 ring-white italic">2</div><span class="hidden sm:block text-[9px] font-black uppercase text-slate-400 italic tracking-widest">المالية</span></div>
                    <div class="relative z-10 flex flex-col items-center gap-2"><div class="step-dot w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-black ring-4 ring-white italic">3</div><span class="hidden sm:block text-[9px] font-black uppercase text-slate-400 italic tracking-widest">الخطة</span></div>
                    <div class="relative z-10 flex flex-col items-center gap-2"><div class="step-dot w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-black ring-4 ring-white italic">4</div><span class="hidden sm:block text-[9px] font-black uppercase text-slate-400 italic tracking-widest">التشخيص</span></div>
                </div>

                <div id="form-step-1" class="active-step bg-white rounded-[4rem] p-12 lg:p-20 shadow-2xl border text-right">
                    <h2 class="text-4xl font-black mb-10 tracking-tighter italic border-b pb-8 italic">أولاً: الملف التعريفي والموقع</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">اسم المشروع / الكيان</label><input type="text" id="f-name" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">القطاع الاستراتيجي</label><select id="f-sector" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></select></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">الدولة</label><input type="text" id="f-country" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">المدينة</label><input type="text" id="f-city" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                    </div>
                    <div class="flex justify-end mt-12"><button onclick="nextStep(2)" class="bg-slate-950 text-white px-12 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 transition-all text-sm uppercase italic">التالي: التحليل المالي</button></div>
                </div>

                <div id="form-step-2" class="hidden bg-white rounded-[4rem] p-12 lg:p-20 shadow-2xl border text-right">
                    <h2 class="text-4xl font-black mb-10 tracking-tighter italic border-b pb-8 text-right italic">ثانياً: التحليل المالي وهيكل الفريق</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">صافي الربح المتوقع (%)</label><input type="number" id="f-profit" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">التمويل المطلوب ($)</label><input type="number" id="f-funding" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">النسبة المتاحة (%)</label><input type="number" id="f-ratio" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">تقييم الفريق (1-5)</label><input type="number" id="f-team-rating" max="5" min="1" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                    </div>
                    <div class="flex justify-between mt-12"><button onclick="nextStep(1)" class="text-slate-400 font-bold px-10 italic">السابق</button><button onclick="nextStep(3)" class="bg-slate-950 text-white px-12 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 transition-all text-sm uppercase italic">التالي: خطة التنفيذ</button></div>
                </div>

                <div id="form-step-3" class="hidden bg-white rounded-[4rem] p-12 lg:p-20 shadow-2xl border text-right">
                    <h2 class="text-4xl font-black mb-10 tracking-tighter italic border-b pb-8 text-right italic">ثالثاً: خطة التنفيذ والجدول الزمني (PMP)</h2>
                    <div class="space-y-8 text-right">
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">ملخص خطة إدارة المشروع (PMP Summary)</label><textarea id="f-pmp-plan" class="w-full p-8 bg-slate-50 border rounded-3xl outline-none font-bold text-lg h-40 italic" placeholder="اشرح بالتفصيل كيف سيتم استخدام التدفق المالي..."></textarea></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">المدة المتوقعة (أشهر)</label><input type="number" id="f-duration" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest">المخاطرة</label><select id="f-risk" class="w-full p-5 bg-slate-50 border rounded-2xl outline-none font-bold text-lg"><option value="Low">Low Risk</option><option value="Medium">Medium Risk</option><option value="High">High Risk</option></select></div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-12"><button onclick="nextStep(2)" class="text-slate-400 font-bold px-10 italic">السابق</button><button onclick="nextStep(4)" class="bg-slate-950 text-white px-12 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 transition-all text-sm uppercase italic">التالي: التشخيص النهائي</button></div>
                </div>

                <div id="form-step-4" class="hidden bg-white rounded-[4rem] p-12 lg:p-20 shadow-2xl border text-right">
                    <h2 class="text-4xl font-black mb-12 tracking-tighter text-center italic uppercase tracking-widest italic">مصفوفة التشخيص الاستراتيجي النهائي (5/5)</h2>
                    <div id="diagnosis-questions-container" class="space-y-8 mb-12 text-right"></div>
                    <div class="flex justify-between mt-12 border-t pt-10"><button onclick="nextStep(3)" class="text-slate-400 font-bold px-10 italic">السابق</button><button onclick="submitDiagnostics()" class="bg-amber-500 text-slate-950 px-16 py-6 rounded-3xl font-black shadow-2xl hover:scale-105 transition-all italic text-xl tracking-tighter uppercase italic">إرسال المشروع للتحليل الذكي BI</button></div>
                </div>
            </div>
        </section>

        <!-- PAGE: MAP -->
        <section id="map-page" class="page-section hidden py-24 admin-theme text-white min-h-screen px-6">
            <div class="container mx-auto text-center">
                <header class="mb-12">
                    <h2 class="text-5xl font-black text-amber-500 tracking-tighter italic mb-4 uppercase italic tracking-widest">Geospatial Asset Map</h2>
                    <p class="text-slate-500 font-bold uppercase text-[10px] tracking-[0.5em] italic">نظام التتبع الجغرافي للأصول الاستراتيجية المدارة</p>
                </header>
                <div id="project-map" class="shadow-2xl border border-white/10 relative z-10"></div>
            </div>
        </section>
    </main>

    <!-- MODAL: ACQUISITION VIEW -->
    <div id="details-modal" class="fixed inset-0 bg-slate-950/98 z-[1000] hidden items-center justify-center p-4 lg:p-12 backdrop-blur-3xl overflow-y-auto">
        <div class="bg-white rounded-[4rem] w-full max-w-7xl overflow-hidden shadow-2xl flex flex-col max-h-[92vh] text-right">
            <div id="modal-view-main" class="flex flex-col h-full">
                <div class="p-10 bg-amber-500 flex justify-between items-center text-slate-950 shrink-0">
                    <div><span id="modal-status-badge" class="bg-slate-950 text-white text-[9px] px-3 py-1 rounded-full font-black uppercase mb-3 inline-block italic tracking-widest">Strategic Match Found</span><h3 id="modal-title" class="text-4xl font-black tracking-tighter italic uppercase tracking-tighter italic">Strategic Project Dossier</h3></div>
                    <button onclick="closeModal()" class="w-16 h-16 bg-slate-950/10 rounded-[2.5rem] flex items-center justify-center hover:bg-slate-950/20 group transition-all"><i data-lucide="x" class="w-8 h-8 group-hover:rotate-90"></i></button>
                </div>
                <div class="overflow-y-auto p-10 lg:p-16 grow space-y-16 custom-scrollbar">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                        <div class="lg:col-span-2 space-y-12"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="modal-metrics-grid"></div></div>
                        <div id="admin-actions-sidebar" class="space-y-8 hidden">
                            <div class="bg-slate-950 text-white p-12 rounded-[3.5rem] border border-white/5 space-y-8 shadow-2xl">
                                <h4 class="text-amber-500 font-black text-[10px] uppercase tracking-[0.3em] italic border-b border-white/10 pb-6 italic">إجراءات Strategy BI</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="updateStatus('Pinned')" class="p-4 bg-white/5 border border-white/10 rounded-2xl hover:bg-amber-500 hover:text-slate-950 transition-all text-[9px] font-black uppercase italic">تثبيت <i data-lucide="pin" class="w-3 h-3 inline"></i></button>
                                    <button onclick="updateStatus('Rejected')" class="p-4 bg-white/5 border border-red-500/30 rounded-2xl text-[9px] font-black uppercase text-red-500 italic">رفض <i data-lucide="x-circle" class="w-3 h-3 inline"></i></button>
                                </div>
                                <hr class="opacity-5"><button onclick="showAcquisitionRoom()" class="w-full bg-amber-500 text-slate-950 py-6 rounded-[2.5rem] font-black shadow-2xl hover:scale-105 transition-all italic tracking-tighter text-lg uppercase italic">بدء مسار الاستحواذ <i data-lucide="zap" class="inline w-5 h-5 mr-1"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- War Room View -->
            <div id="modal-view-acquisition" class="hidden flex flex-col h-full bg-slate-50">
                <div class="p-10 bg-slate-950 text-white flex justify-between items-center shrink-0"><div class="flex items-center gap-6"><button onclick="backToMainView()" class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center hover:bg-white/20 transition-all"><i data-lucide="chevron-right" class="w-6 h-6"></i></button><div><h3 class="text-4xl font-black tracking-tighter italic uppercase text-amber-500 italic">Negotiation <span class="text-white italic">War-Room</span></h3><p class="text-slate-500 text-[10px] font-black uppercase tracking-[0.2em] italic">نظام التفاوض الاستراتيجي وإغلاق الصفقات</p></div></div></div>
                <div id="acq-path-selection" class="p-16 grow flex flex-col justify-center items-center gap-12 text-center">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-5xl">
                        <div onclick="activatePath('شراء كامل')" class="p-12 bg-white rounded-[4rem] border cursor-pointer hover:border-amber-500 shadow-xl group transition-all"><div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform"><i data-lucide="landmark" class="w-10 h-10"></i></div><h4 class="font-black text-xl italic uppercase italic">الاستحواذ الكلي المباشر</h4></div>
                        <div onclick="activatePath('شراكة')" class="p-12 bg-white rounded-[4rem] border cursor-pointer hover:border-amber-500 shadow-xl group transition-all"><div class="w-20 h-20 bg-amber-50 text-amber-600 rounded-3xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform"><i data-lucide="users" class="w-10 h-10"></i></div><h4 class="font-black text-xl italic uppercase italic">شراكة أسهم استراتيجية</h4></div>
                        <div onclick="activatePath('وساطة')" class="p-12 bg-white rounded-[4rem] border cursor-pointer hover:border-amber-500 shadow-xl group transition-all"><div class="w-20 h-20 bg-green-50 text-green-600 rounded-3xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform"><i data-lucide="target" class="w-10 h-10"></i></div><h4 class="font-black text-xl italic uppercase italic">وساطة ومطابقة استثمارية</h4></div>
                    </div>
                </div>
                <div id="acq-active-room" class="hidden p-10 grow overflow-hidden flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-2/3 bg-white rounded-[4rem] shadow-2xl flex flex-col overflow-hidden border">
                        <div id="chat-messages-live" class="grow p-10 overflow-y-auto space-y-10 custom-scrollbar bg-slate-50/20 italic font-bold"></div>
                        <div class="p-10 border-t flex gap-4"><input type="text" placeholder="اكتب العرض المالي..." class="grow bg-slate-50 border rounded-2xl px-6 py-4 outline-none font-bold text-sm focus:ring-1 focus:ring-amber-500"><button class="bg-slate-950 text-white px-8 py-4 rounded-2xl shadow-xl hover:scale-105 transition-all"><i data-lucide="send"></i></button></div>
                    </div>
                    <div class="lg:w-1/3"><div class="bg-slate-950 text-white p-10 rounded-[4rem] shadow-2xl space-y-10 border border-white/5"><h4 class="font-black text-amber-500 text-[10px] uppercase tracking-widest italic border-b border-white/5 pb-6 italic">حزمة الإغلاق الاستراتيجي</h4><div class="space-y-4"><button onclick="simulateSend('MoU')" class="w-full bg-white/5 p-6 rounded-3xl text-[9px] font-black flex justify-between items-center hover:bg-white/10 transition-all uppercase italic">إصدار مذكرة تفاهم MoU <i data-lucide="file-check"></i></button><button class="w-full bg-amber-500 text-slate-950 p-6 rounded-[2.5rem] font-black text-xs shadow-2xl italic tracking-tighter uppercase mt-6 italic">إغلاق الاستحواذ بنجاح</button></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, markersGroup, projects = [], currentProjectId = null, userRole = 'user';

        const SECTORS = [
            "حلول الذكاء الاصطناعي والأتمتة", "الأمن السيبراني المتطور", "التقنيات المالية (FinTech)", 
            "الخدمات اللوجستية الذكية", "الطاقة المستدامة والمتجددة", "التقنيات الزراعية (AgTech)", 
            "تكنولوجيا الرعاية الصحية", "التجارة الرقمية المتقدمة", "تكنولوجيا التعليم الرقمي", "إدارة الأصول العقارية"
        ];

        const CITY_COORDS = { "الرياض": [24.71, 46.67], "دبي": [25.20, 55.27], "جدة": [21.48, 39.19], "القاهرة": [30.04, 31.23], "المنامة": [26.22, 50.58], "الكويت": [29.37, 47.97], "مسقط": [23.58, 58.40], "الدوحة": [25.28, 51.53] };

        const REALISTIC_COMPANIES = [
            "سديم للحلول الرقمية", "نماء للتقنيات الزراعية", "شركة مآل المالية", "أفق للخدمات اللوجستية",
            "روابي للطاقة المتجددة", "ثراء للذكاء الاصطناعي", "درع للأمن السيبراني", "كيان للتجارة الإلكترونية"
        ];

        const SMART_QUESTIONS = [
            { q:1, text: "ما هو المحرك الأساسي للقيمة المضافة (Unique Value) في مشروعك؟", opts: [{v:"A", t:"أصول فيزيائية ملموسة"}, {v:"B", t:"خوارزميات وبرمجيات"}, {v:"C", t:"بيانات ضخمة وملكيات فكرية"}] },
            { q:2, text: "كيف يتم التعامل مع التوسع الجغرافي (Scalability)؟", opts: [{v:"A", t:"يتطلب فروعاً مادية"}, {v:"B", t:"توسع رقمي تدريجي"}, {v:"C", t:"قابل للتكرار عالمياً فوراً"}] },
            { q:3, text: "ما مدى الاعتمادية على تقنيات الطرف الثالث (Third Party)؟", opts: [{v:"A", t:"تبعية كاملة لشركات كبرى"}, {v:"B", t:"تبعية جزئية (APIs)"}, {v:"C", t:"سيادة تقنية كاملة"}] },
            { q:4, text: "متى تتوقع أن يصل الكيان لنقطة الربحية الكاملة (Breakeven)؟", opts: [{v:"A", t:"أكثر من 24 شهراً"}, {v:"B", t:"خلال 12-18 شهراً"}, {v:"C", t:"أقل من 6 أشهر"}] }
        ];

        function seedData() {
            projects = [];
            const cities = Object.keys(CITY_COORDS);
            for(let i=1; i<=25; i++) {
                const city = cities[i % cities.length];
                const profit = 15 + Math.floor(Math.random() * 45);
                const funding = (Math.random() * 45 + 5).toFixed(1);
                projects.push({
                    id: i, name: REALISTIC_COMPANIES[i % REALISTIC_COMPANIES.length] + " " + (i),
                    sector: SECTORS[i % SECTORS.length], city: city, coords: CITY_COORDS[city], country: "السعودية",
                    profit: profit, funding: funding, risk: ["Low", "Medium", "High"][i % 3], teamRating: (Math.random()*2+3).toFixed(1),
                    status: 'Active', alignment: (Math.random()*15+82).toFixed(1)
                });
            }
        }

        function init() {
            seedData();
            const sectorRef = document.getElementById('sectors-ref-container');
            const filSector = document.getElementById('filter-sector');
            const fSector = document.getElementById('f-sector');
            if(filSector) filSector.innerHTML = '<option value="all">كافة القطاعات</option>';
            SECTORS.forEach(s => {
                const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
                if(filSector) filSector.appendChild(opt.cloneNode(true));
                if(fSector) fSector.appendChild(opt);
                if(sectorRef) {
                    const div = document.createElement('div');
                    div.className = "bg-slate-50 p-10 rounded-[3rem] border group hover:bg-white hover:shadow-2xl transition-all text-right";
                    div.innerHTML = `<h4 class="font-black text-slate-800 mb-2 italic text-lg tracking-tighter italic">${s}</h4><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest italic">تحليل الأصول والبيانات الاستراتيجية</p>`;
                    sectorRef.appendChild(div);
                }
            });

            const qContainer = document.getElementById('diagnosis-questions-container');
            if(qContainer) {
                SMART_QUESTIONS.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-slate-50 p-10 rounded-[4rem] border border-slate-100 shadow-sm";
                    div.innerHTML = `<p class="font-black text-slate-800 mb-8 italic text-lg border-r-4 border-amber-500 pr-4 italic">${item.text}</p><div class="grid grid-cols-1 md:grid-cols-3 gap-6">${item.opts.map(o => `<label class="flex items-center gap-4 p-5 bg-white rounded-[2rem] border-2 cursor-pointer hover:border-amber-500 transition-all font-black text-xs italic"><input type="radio" name="q${item.q}" value="${o.v}" class="w-6 h-6 accent-amber-500"> ${o.t}</label>`).join('')}</div>`;
                    qContainer.appendChild(div);
                });
            }

            initMap();
            applyFilters();
            renderInvestorMatches();
            renderChatList();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function setRole(role) {
            userRole = role;
            ['user', 'inv', 'adm'].forEach(r => {
                const btn = document.getElementById(`role-${r}-btn`);
                if(btn) btn.className = r === role ? "px-3 md:px-5 py-1.5 rounded-full text-[9px] font-black transition-all bg-white shadow-sm text-slate-900 border" : "px-3 md:px-5 py-1.5 rounded-full text-[9px] font-black transition-all text-slate-400";
            });
            document.getElementById('nav-inv-btn').classList.toggle('hidden', role !== 'investor');
            document.getElementById('mob-inv-btn').classList.toggle('hidden', role !== 'investor');
            document.getElementById('nav-adm-btn').classList.toggle('hidden', role !== 'admin');
            document.getElementById('mob-adm-btn').classList.toggle('hidden', role !== 'admin');
            document.getElementById('nav-msg-btn').classList.toggle('hidden', role !== 'admin');
            document.getElementById('mob-msg-btn').classList.toggle('hidden', role !== 'admin');
            
            if(role === 'admin') showPage('dashboard'); else if(role === 'investor') showPage('inv-dash'); else showPage('landing');
            showNotification(`تم تفعيل وضع: ${role === 'admin' ? 'الإدارة (BI)' : role === 'investor' ? 'المستثمر' : 'رائد العمل'}`);
        }

        function applyFilters() {
            const search = document.getElementById('filter-search')?.value.toLowerCase() || "";
            const sector = document.getElementById('filter-sector')?.value || "all";
            const risk = document.getElementById('filter-risk')?.value || "all";
            const profitVal = parseFloat(document.getElementById('filter-profit-val')?.value) || 0;
            const fundingVal = parseFloat(document.getElementById('filter-funding-val')?.value) || Infinity;

            const filtered = projects.filter(p => {
                const sMatch = p.name.toLowerCase().includes(search) || p.city.toLowerCase().includes(search);
                const sectorMatch = sector === 'all' || p.sector === sector;
                const riskMatch = risk === 'all' || p.risk === risk;
                const profitMatch = p.profit >= profitVal;
                const fundingMatch = parseFloat(p.funding) <= fundingVal;
                return sMatch && sectorMatch && riskMatch && profitMatch && fundingMatch;
            });

            renderTable(filtered);
            updateStats(filtered);
            renderMapMarkers(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('admin-table-body');
            if(!tbody) return;
            tbody.innerHTML = data.map(p => `
                <tr class="hover:bg-white/[0.04] transition-all group">
                    <td class="p-8" data-label="المشروع"><div><div class="font-black text-slate-100 italic tracking-tighter text-lg">${p.name}</div><div class="text-[9px] text-amber-500 font-black uppercase mt-1 italic tracking-[0.2em] italic">${p.sector}</div></div></td>
                    <td class="p-8 text-center font-black text-amber-500 text-xl italic" data-label="الربحية">${p.profit}%</td>
                    <td class="p-8 text-center font-black text-slate-300 italic" data-label="التمويل">$${p.funding}M</td>
                    <td class="p-8 text-center" data-label="المخاطرة"><span class="px-3 py-1 rounded-full text-[8px] font-black uppercase border ${p.risk==='Low'?'border-green-500 text-green-500':p.risk==='High'?'border-red-500 text-red-500':'border-yellow-500 text-yellow-500'} italic">${p.risk}</span></td>
                    <td class="p-8 text-center" data-label="الحالة"><span class="text-[8px] font-black px-4 py-2 bg-white/5 rounded-full ${p.status==='Rejected'?'text-red-500':'text-green-500'} uppercase italic italic">${p.status}</span></td>
                    <td class="p-8 text-center" data-label="تحليل"><button onclick="viewProject(${p.id})" class="text-amber-500 hover:scale-125 transition-transform"><i data-lucide="microscope" class="w-6 h-6"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function updateStats(data) {
            const t = data.length;
            const funding = data.reduce((a, b) => a + parseFloat(b.funding), 0).toFixed(0);
            const profit = t > 0 ? (data.reduce((a, b) => a + b.profit, 0) / t).toFixed(1) : 0;
            const team = t > 0 ? (data.reduce((a, b) => a + parseFloat(b.teamRating), 0) / t).toFixed(1) : 0;
            if(document.getElementById('stat-total')) document.getElementById('stat-total').textContent = t;
            if(document.getElementById('stat-total-funding')) document.getElementById('stat-total-funding').textContent = `$${funding}M`;
            if(document.getElementById('stat-avg-profit')) document.getElementById('stat-avg-profit').textContent = `${profit}%`;
            if(document.getElementById('stat-avg-team')) document.getElementById('stat-avg-team').textContent = `${team}/5`;
        }

        function renderInvestorMatches() {
            const container = document.getElementById('investor-match-list');
            if(!container) return;
            const matches = projects.sort((a,b) => b.alignment - a.alignment).slice(0, 8);
            container.innerHTML = matches.map(p => `
                <div class="flex flex-col lg:flex-row items-center justify-between p-10 lg:p-12 glass-card rounded-[4rem] hover:bg-white/10 transition-all gap-8">
                    <div class="flex items-center gap-8">
                        <div class="w-20 h-20 bg-green-500/20 text-green-400 rounded-[2rem] flex items-center justify-center font-black text-2xl shadow-2xl">${p.alignment}%</div>
                        <div><h4 class="font-black text-2xl italic tracking-tighter italic">${p.name}</h4><p class="text-[9px] text-slate-500 font-black uppercase italic tracking-[0.2em] mt-2 italic">${p.sector} • ${p.city}</p></div>
                    </div>
                    <div class="flex flex-wrap items-center gap-10">
                        <div class="text-center border-r border-white/5 pr-10"><p class="text-[9px] text-slate-500 font-black mb-1 uppercase italic italic">Funding Cap</p><p class="text-white font-black text-2xl italic tracking-tighter">$${p.funding}M</p></div>
                        <button onclick="viewProject(${p.id})" class="bg-green-500 text-slate-950 px-10 py-5 rounded-3xl font-black text-xs uppercase shadow-2xl hover:scale-105 transition-all italic tracking-tighter italic">تحليل الاستحواذ</button>
                    </div>
                </div>
            `).join('');
        }

        function initMap() {
            const mapEl = document.getElementById('project-map');
            if(!mapEl || map) return;
            map = L.map('project-map').setView([24, 45], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            markersGroup = L.layerGroup().addTo(map);
        }

        function renderMapMarkers(data) {
            if(!markersGroup) return;
            markersGroup.clearLayers();
            data.forEach(p => {
                const icon = L.divIcon({ className: 'custom-icon', html: `<div style="background:#f59e0b;width:16px;height:16px;border:2px solid white;border-radius:50%;box-shadow:0 0 10px #f59e0b"></div>`, iconSize: [16, 16] });
                if(p.coords) L.marker(p.coords, { icon: icon }).addTo(markersGroup).bindPopup(`<div class="text-right font-black text-[10px] italic p-2"><p class="text-amber-500 mb-2 font-black">${p.name}</p><button onclick="viewProject(${p.id})" class="w-full py-2 bg-amber-500 rounded-xl text-slate-950 italic">تحليل BI</button></div>`);
            });
        }

        function viewProject(id) {
            currentProjectId = id;
            const p = projects.find(x => x.id == id);
            if(!p) return;
            document.getElementById('modal-title').textContent = p.name;
            document.getElementById('modal-status-badge').textContent = p.status;
            document.getElementById('modal-metrics-grid').innerHTML = `
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest italic">الموقع</span><p class="font-black text-slate-800 text-lg">${p.city}, ${p.country}</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest italic">صافي الربح</span><p class="font-black text-amber-600 text-3xl italic tracking-tighter">${p.profit}%</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest italic">التمويل</span><p class="font-black text-slate-800 text-2xl italic tracking-tighter">$${p.funding}M</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest italic">المواءمة</span><p class="font-black text-green-600 text-2xl italic tracking-tighter">${p.alignment}%</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest italic">الفريق</span><p class="font-black text-blue-600 text-2xl italic tracking-tighter">${p.teamRating}/5</p></div>
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border"><span class="text-slate-400 block text-[9px] uppercase font-black italic mb-2 tracking-widest italic">المخاطرة</span><p class="font-black text-slate-800 text-xl uppercase italic">${p.risk}</p></div>
            `;
            if(userRole === 'admin') document.getElementById('admin-actions-sidebar').classList.remove('hidden'); else document.getElementById('admin-actions-sidebar').classList.add('hidden');
            backToMainView();
            document.getElementById('details-modal').classList.remove('hidden');
            document.getElementById('details-modal').classList.add('flex');
            lucide.createIcons();
        }

        function showAcquisitionRoom() { document.getElementById('modal-view-main').classList.add('hidden'); document.getElementById('modal-view-acquisition').classList.remove('hidden'); lucide.createIcons(); }
        function backToMainView() { document.getElementById('modal-view-acquisition').classList.add('hidden'); document.getElementById('modal-view-main').classList.remove('hidden'); document.getElementById('acq-path-selection').classList.remove('hidden'); document.getElementById('acq-active-room').classList.add('hidden'); }
        function activatePath(path) {
            document.getElementById('acq-path-selection').classList.add('hidden');
            document.getElementById('acq-active-room').classList.remove('hidden');
            const msgLive = document.getElementById('chat-messages-live');
            msgLive.innerHTML = `<div class="flex justify-start"><div class="p-6 bg-white border rounded-[2rem] max-w-[85%] text-xs shadow-xl italic">أهلاً بكم فريق الإدارة. نحن منفتحون جداً لمناقشة مسار [${path}]. لقد قمنا بتحميل ملفات الفحص المالي بانتظار عرضكم الأول.</div></div>`;
            lucide.createIcons();
        }

        function updateStatus(status) { const p = projects.find(x => x.id == currentProjectId); if(p) { p.status = status; showNotification(`تحديث الحالة: ${status}`); viewProject(currentProjectId); applyFilters(); } }
        function simulateSend(type) { showNotification(`جاري تنفيذ بروتوكول ${type}...`); setTimeout(() => showNotification(`تم تنفيذ ${type} بنجاح ✅`), 1500); }

        function renderChatList() {
            const container = document.getElementById('chat-list');
            if(!container) return;
            container.innerHTML = projects.slice(0, 10).map(p => `
                <div onclick="openChat(${p.id})" class="p-6 bg-white border rounded-[2.5rem] flex items-center gap-4 cursor-pointer hover:border-amber-500 transition-all shadow-sm group">
                    <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center font-black italic text-sm group-hover:bg-amber-500 group-hover:text-slate-900 transition-colors">${p.name[0]}</div>
                    <div class="grow overflow-hidden text-right">
                        <p class="text-[11px] font-black truncate italic">${p.name}</p>
                        <p class="text-[9px] text-slate-400 font-bold italic truncate italic uppercase tracking-widest">Live Channel</p>
                    </div>
                </div>
            `).join('');
        }

        function openChat(id) {
            const p = projects.find(x => x.id == id);
            document.getElementById('chat-target-name').textContent = p.name;
            const msgContainer = document.getElementById('chat-messages-container');
            msgContainer.className = "grow p-12 overflow-y-auto space-y-8 custom-scrollbar bg-slate-50/20";
            msgContainer.innerHTML = `<div class="flex justify-start"><div class="p-8 bg-white border rounded-[2rem] max-w-[85%] text-sm font-bold shadow-xl bg-white border italic">تحية طيبة لفريق كنوز. بانتظار ردكم على شروط الاستحواذ المقترحة لكيان [${p.name}].</div></div>`;
            showPage('messages');
        }

        function fillDefaultFormData() {
            document.getElementById('f-name').value = "سديم للحلول السحابية المتقدمة";
            document.getElementById('f-sector').value = "حلول الذكاء الاصطناعي والأتمتة";
            document.getElementById('f-country').value = "المملكة العربية السعودية";
            document.getElementById('f-city').value = "الرياض";
            document.getElementById('f-profit').value = 42;
            document.getElementById('f-funding').value = 3500000;
            document.getElementById('f-ratio').value = 30;
            document.getElementById('f-team-rating').value = 5;
            document.getElementById('f-pmp-plan').value = "خطة توسع استراتيجية تهدف لدمج خوارزميات الذكاء الاصطناعي في قطاع اللوجستيات لتقليل التكاليف بنسبة 40% خلال السنة الأولى.";
            document.getElementById('f-duration').value = 18;
            document.getElementById('f-risk').value = "Low";
            document.querySelectorAll('input[type="radio"]').forEach((el, i) => { if((i+1)%3 === 0) el.checked = true; });
        }

        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            const el = document.getElementById(`${id}-page`);
            if(el) el.classList.add('active-section'); 
            if(el) el.classList.remove('hidden');
            if(id === 'form') fillDefaultFormData();
            if(id === 'map' && map) setTimeout(() => map.invalidateSize(), 300);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep(s) { 
            document.querySelectorAll('[id^="form-step-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`form-step-${s}`).classList.remove('hidden');
            document.getElementById('step-line').style.width = `${(s-1)*33.33}%`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function submitDiagnostics() {
            document.getElementById('loading-screen').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                showNotification("تم إرسال المشروع الاستراتيجي بنجاح. جاري التحليل عبر BI.");
                showPage('ent-dash');
                nextStep(1);
            }, 2500);
        }

        function showNotification(text) { const toast = document.getElementById('notification'); document.getElementById('notification-text').textContent = text; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 4500); }
        function closeModal() { document.getElementById('details-modal').classList.add('hidden'); }
        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); document.getElementById('mobile-menu').classList.toggle('flex'); }

        window.onload = init;
    </script>
</body>
</html>
